---
roles:

  # General Purpose Roles
  # =====================
  base:
    private_networks:
      - {ip: '0.0.0.0', auto_network: true}
    provisioners:
      - {type: hosts}

  el-stop-firewall:
    provisioners:
      - {type: shell, inline: 'service iptables stop'}
      - {type: shell, inline: 'chkconfig iptables off'}

  1gb-memory:
    provider:
      type: virtualbox
      customize:
        - [modifyvm, !ruby/sym id, '--memory', 1024]

  2gb-memory:
    provider:
      type: virtualbox
      customize:
        - [modifyvm, !ruby/sym id, '--memory', 2048]

  4gb-memory:
    provider:
      type: virtualbox
      customize:
        - [modifyvm, !ruby/sym id, '--memory', 4096]


  # Puppet Open Source Roles
  # ========================
  el-6-repos:
    provisioners:
      - type: shell
        inline: |
          if yum list epel-release > /dev/null 2>&1; then
            echo 'EPEL repo present.'
          else
            echo 'Adding EPEL repos.'
            rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
          fi

          if yum list puppetlabs-release > /dev/null 2>&1; then
            echo 'PL repos present.'
          else
            echo 'Adding PL repos.'
            rpm -ivh http://yum.puppetlabs.com/el/6/products/i386/puppetlabs-release-6-7.noarch.rpm
          fi

  el-6-ruby193:
    provisioners:
      - type: shell
        # The EOF must be quoted to prevent shell expansion.
        inline: |-
          yum install -y centos-release-SCL
          yum install -y ruby193-ruby-devel

          tee /etc/profile.d/enable-ruby193.sh << "EOF"
          # Enable ruby193 by default
          source /opt/rh/ruby193/enable
          # Place scripts installed by ruby193 gems on the PATH
          export PATH=/opt/rh/ruby193/root/usr/local/bin:$PATH
          EOF

  poss-rh-repos:
    provisioners:
      - type: shell
        inline: | # Should work on CentOS and Fedora.
          rpm --quiet -q puppetlabs-release || {
            if [ -f /etc/fedora-release ]; then
              RH_DIST='fedora'
            else
              RH_DIST='el'
            fi
            RH_VERS=$(rpm -q --qf "%{VERSION}" $(rpm -q --whatprovides redhat-release))

            rpm -ivh "http://yum.puppetlabs.com/puppetlabs-release-$RH_DIST-$RH_VERS.noarch.rpm"
          }

  poss-deb-repos:
    provisioners:
      - type: shell
        inline: | # Cribbed from the Beaker utility library. Should work on Debian and Ubuntu.
          dpkg -s puppetlabs-release | grep -q '^Status:.* installed' || {
            apt-get install -y curl
            curl -O http://apt.puppetlabs.com/puppetlabs-release-$(lsb_release -c -s).deb
            dpkg -i puppetlabs-release-$(lsb_release -c -s).deb
            apt-get -y -f -m update
          }

  poss-envpuppet:
    synced_folders:
      - {host_path: 'src/puppetlabs', guest_path: '/puppetlabs'}
    provisioners:
      - type: shell
        # The EOF must be quoted to prevent shell expansion of the second line.
        inline: |-
          tee /etc/profile.d/envpuppet.sh << "EOF"
          export ENVPUPPET_BASEDIR=/puppetlabs
          eval $($ENVPUPPET_BASEDIR/puppet/ext/envpuppet)
          EOF


  # PE Specific Roles
  # =================
  pe-forward-console:
    forwarded_ports:
      - {guest: 443, host: 4443, auto_correct: true}

  pe-321-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '3.2.1'}

  pe-321-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-321-master.puppetdebug.vlan', version: '3.2.1'}

  pe-313-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '3.1.3'}

  pe-313-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-313-master.puppetdebug.vlan', version: '3.1.3'}

  pe-301-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '3.0.1'}

  pe-301-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-301-master.puppetdebug.vlan', version: '3.0.1'}

  pe-285-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '2.8.5'}

  pe-285-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-285-master.puppetdebug.vlan', version: '2.8.5'}

  pe-272-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '2.7.2'}

  pe-272-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-272-master.puppetdebug.vlan', version: '2.7.2'}

  pe-261-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '2.6.1'}

  pe-261-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-261-master.puppetdebug.vlan', version: '2.6.1'}

  pe-253-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '2.5.3'}

  pe-253-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-253-master.puppetdebug.vlan', version: '2.5.3'}

  pe-203-master:
    provisioners:
      - {type: pe_bootstrap, role: !ruby/sym master, version: '2.0.3'}

  pe-203-agent:
    provisioners:
      - {type: pe_bootstrap, master: 'pe-203-master.puppetdebug.vlan', version: '2.0.3'}
